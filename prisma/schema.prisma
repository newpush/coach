generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                                 String                       @id @default(uuid())
  name                               String?
  email                              String                       @unique
  emailVerified                      DateTime?
  image                              String?
  createdAt                          DateTime                     @default(now())
  updatedAt                          DateTime                     @updatedAt
  ftp                                Int?
  maxHr                              Int?
  weight                             Float?
  dob                                DateTime?
  currentFitnessScore                Int?
  recoveryCapacityScore              Int?
  nutritionComplianceScore           Int?
  trainingConsistencyScore           Int?
  profileLastUpdated                 DateTime?
  currentFitnessExplanation          String?
  recoveryCapacityExplanation        String?
  nutritionComplianceExplanation     String?
  trainingConsistencyExplanation     String?
  currentFitnessExplanationJson      Json?
  recoveryCapacityExplanationJson    Json?
  nutritionComplianceExplanationJson Json?
  trainingConsistencyExplanationJson Json?
  city                               String?
  country                            String?
  distanceUnits                      String?                      @default("Kilometers")
  form                               String?                      @default("Absolute value")
  height                             Int?
  heightUnits                        String?                      @default("cm")
  language                           String?                      @default("English")
  restingHr                          Int?
  sex                                String?
  state                              String?
  temperatureUnits                   String?                      @default("Celsius")
  timezone                           String?
  visibility                         String?                      @default("Private")
  weightUnits                        String?                      @default("Kilograms")
  hrZones                            Json?
  powerZones                         Json?
  aiAutoAnalyzeNutrition             Boolean                      @default(false)
  aiAutoAnalyzeWorkouts              Boolean                      @default(false)
  aiModelPreference                  String?                      @default("flash")
  aiPersona                          String?                      @default("Supportive")
  dashboardSettings                  Json?
  altitude                           Int?
  isAdmin                            Boolean                      @default(false)
  lthr                               Int?
  healthConsentAcceptedAt            DateTime?
  privacyPolicyVersion               String?
  termsAcceptedAt                    DateTime?
  termsVersion                       String?
  hrPowerAlignmentExplanation        String?
  hrPowerAlignmentExplanationJson    Json?
  hrPowerAlignmentScore              Int?
  aiContext                          String?
  nickname                           String?
  nutritionTrackingEnabled           Boolean                      @default(true)
  recoverySensitivity                String?                      @default("MEDIUM")
  currencyPreference                 String?
  lastLoginAt                        DateTime?
  lastLoginIp                        String?
  stripeCustomerId                   String?                      @unique
  stripeSubscriptionId               String?                      @unique
  subscriptionPeriodEnd              DateTime?
  subscriptionStatus                 SubscriptionStatus           @default(NONE)
  subscriptionTier                   SubscriptionTier             @default(FREE)
  aiDeepAnalysisEnabled              Boolean                      @default(false)
  aiProactivityEnabled               Boolean                      @default(false)
  aiAutoAnalyzeReadiness             Boolean                      @default(false)
  accounts                           Account[]
  activityRecommendations            ActivityRecommendation[]
  apiKeys                            ApiKey[]
  auditLogs                          AuditLog[]
  calendarNotes                      CalendarNote[]
  chatParticipations                 ChatParticipant[]
  invites                            CoachingInvite[]
  coaches                            CoachingRelationship[]       @relation("AthleteRelation")
  athletes                           CoachingRelationship[]       @relation("CoachRelation")
  dailyCheckins                      DailyCheckin[]
  dailyMetrics                       DailyMetric[]
  events                             Event[]
  fitFiles                           FitFile[]
  goals                              Goal[]
  integrations                       Integration[]
  llmUsage                           LlmUsage[]
  nutrition                          Nutrition[]
  oauthApps                          OAuthApp[]
  oauthCodes                         OAuthAuthCode[]
  oauthConsents                      OAuthConsent[]
  oauthTokens                        OAuthToken[]
  plannedWorkouts                    PlannedWorkout[]
  recommendations                    Recommendation[]
  reports                            Report[]
  reportTemplates                    ReportTemplate[]
  scoreTrendExplanations             ScoreTrendExplanation[]
  sessions                           Session[]
  shareTokens                        ShareToken[]
  sportSettings                      SportSettings[]
  supportMessages                    SupportMessage[]
  bugReports                         BugReport[]
  syncQueue                          SyncQueue[]
  trainingAvailability               TrainingAvailability[]
  trainingPlans                      TrainingPlan[]
  systemMessageDismissals            UserSystemMessageDismissal[]
  weeklyTrainingPlans                WeeklyTrainingPlan[]
  wellness                           Wellness[]
  workouts                           Workout[]
  nutritionSettings                  UserNutritionSettings?

  @@index([createdAt])
  @@index([subscriptionTier])
}

model SportSettings {
  id                  String   @id @default(cuid())
  userId              String
  types               String[]
  ftp                 Int?
  indoorFtp           Int?
  wPrime              Int?
  powerZones          Json?
  lthr                Int?
  maxHr               Int?
  hrZones             Json?
  thresholdPace       Float?
  paceZones           Json?
  source              String   @default("intervals")
  externalId          String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  cooldownTime        Int?
  eFtp                Int?
  ePMax               Int?
  eWPrime             Int?
  eftpMinDuration     Int?
  hrLoadType          String?
  loadPreference      String?
  pMax                Int?
  powerSpikeThreshold Int?
  restingHr           Int?
  warmupTime          Int?
  zoneConfiguration   Json?
  name                String?
  isDefault           Boolean  @default(false)
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, source, externalId])
  @@index([userId])
}

model SystemMessage {
  id         String                       @id @default(uuid())
  title      String
  content    String
    type         String                       @default("INFO")
    isActive     Boolean                      @default(true)
    targetUrl    String?
    actionLabel  String?
    expiresAt    DateTime?
  createdAt  DateTime                     @default(now())
  updatedAt  DateTime                     @updatedAt
  dismissals UserSystemMessageDismissal[]
}

model UserSystemMessageDismissal {
  id              String        @id @default(uuid())
  userId          String
  systemMessageId String
  dismissedAt     DateTime      @default(now())
  systemMessage   SystemMessage @relation(fields: [systemMessageId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, systemMessageId])
  @@index([userId])
}

model OAuthApp {
  id           String          @id @default(uuid())
  name         String
  description  String?
  homepageUrl  String?
  logoUrl      String?
  clientId     String          @unique @default(dbgenerated("gen_random_uuid()"))
  clientSecret String
  redirectUris String[]
  isTrusted    Boolean         @default(false)
  isPublic     Boolean         @default(false)
  ownerId      String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  owner        User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  codes        OAuthAuthCode[]
  consents     OAuthConsent[]
  tokens       OAuthToken[]

  @@index([ownerId])
}

model OAuthConsent {
  id        String   @id @default(uuid())
  userId    String
  appId     String
  scopes    String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  app       OAuthApp @relation(fields: [appId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, appId])
}

model OAuthAuthCode {
  code                String   @id @unique
  appId               String
  userId              String
  redirectUri         String
  scopes              String[]
  codeChallenge       String?
  codeChallengeMethod String?  @default("S256")
  expiresAt           DateTime
  createdAt           DateTime @default(now())
  app                 OAuthApp @relation(fields: [appId], references: [id], onDelete: Cascade)
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OAuthToken {
  id                    String    @id @default(uuid())
  accessToken           String    @unique
  refreshToken          String?   @unique
  accessTokenExpiresAt  DateTime
  refreshTokenExpiresAt DateTime?
  appId                 String
  userId                String
  scopes                String[]
  createdAt             DateTime  @default(now())
  lastUsedAt            DateTime?
  lastIp                String?
  app                   OAuthApp  @relation(fields: [appId], references: [id], onDelete: Cascade)
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([accessToken])
  @@index([refreshToken])
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?
  action       String
  resourceType String?
  resourceId   String?
  ipAddress    String?
  userAgent    String?
  metadata     Json?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model ShareToken {
  id           String    @id @default(uuid())
  userId       String
  resourceType String
  resourceId   String
  token        String    @unique @default(dbgenerated("gen_random_uuid()"))
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([resourceType, resourceId])
}

model ApiKey {
  id         String    @id @default(uuid())
  userId     String
  name       String
  key        String    @unique
  prefix     String
  lastUsedAt DateTime?
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([key])
}

model CoachingRelationship {
  id          String   @id @default(uuid())
  coachId     String
  athleteId   String
  status      String   @default("ACTIVE")
  permissions Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  athlete     User     @relation("AthleteRelation", fields: [athleteId], references: [id], onDelete: Cascade)
  coach       User     @relation("CoachRelation", fields: [coachId], references: [id], onDelete: Cascade)

  @@unique([coachId, athleteId])
  @@index([coachId])
  @@index([athleteId])
}

model CoachingInvite {
  id        String   @id @default(uuid())
  athleteId String
  code      String   @unique
  expiresAt DateTime
  usedBy    String?
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  athlete   User     @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@index([code])
}

model Goal {
  id            String         @id @default(uuid())
  userId        String
  type          String
  title         String
  description   String?
  metric        String?
  currentValue  Float?
  targetValue   Float?
  startValue    Float?
  targetDate    DateTime?
  eventDate     DateTime?
  eventType     String?
  status        String         @default("ACTIVE")
  priority      String         @default("MEDIUM")
  aiContext     String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  distance      Float?
  duration      Float?
  elevation     Int?
  phase         String?
  terrain       String?
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  trainingPlans TrainingPlan[]
  events        Event[]        @relation("EventToGoal")

  @@index([userId])
}

model Event {
  id               String   @id @default(uuid())
  userId           String
  externalId       String?
  source           String?
  title            String
  description      String?
  date             DateTime
  type             String?
  subType          String?
  distance         Float?
  elevation        Int?
  expectedDuration Float?
  terrain          String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  city             String?
  country          String?
  isPublic         Boolean  @default(false)
  isVirtual        Boolean  @default(false)
  location         String?
  priority         String?  @default("B")
  websiteUrl       String?
  startTime        String?
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  goals            Goal[]   @relation("EventToGoal")

  @@unique([userId, source, externalId])
  @@index([userId])
  @@index([date])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Integration {
  id                   String    @id @default(uuid())
  userId               String
  provider             String
  accessToken          String
  refreshToken         String?
  expiresAt            DateTime?
  externalUserId       String?
  scope                String?
  lastSyncAt           DateTime?
  syncStatus           String?
  errorMessage         String?
  initialSyncCompleted Boolean?  @default(false)
  ingestWorkouts       Boolean   @default(false)
  settings             Json?
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
}

model Workout {
  id                              String            @id @default(uuid())
  userId                          String
  externalId                      String
  source                          String
  date                            DateTime
  title                           String
  description                     String?
  type                            String?
  durationSec                     Int
  distanceMeters                  Float?
  elevationGain                   Int?
  averageWatts                    Int?
  maxWatts                        Int?
  normalizedPower                 Int?
  averageHr                       Int?
  maxHr                           Int?
  tss                             Float?
  kilojoules                      Int?
  rawJson                         Json?
  atl                             Float?
  averageCadence                  Int?
  averageSpeed                    Float?
  avgTemp                         Float?
  createdAt                       DateTime          @default(now())
  ctl                             Float?
  decoupling                      Float?
  efficiencyFactor                Float?
  feel                            Int?
  ftp                             Int?
  intensity                       Float?
  lrBalance                       Float?
  maxCadence                      Int?
  polarizationIndex               Float?
  powerHrRatio                    Float?
  rpe                             Int?
  sessionRpe                      Int?
  trainer                         Boolean?
  trainingLoad                    Float?
  trimp                           Int?
  updatedAt                       DateTime          @updatedAt
  variabilityIndex                Float?
  weightedAvgWatts                Int?
  aiAnalysis                      String?
  aiAnalyzedAt                    DateTime?
  aiAnalysisStatus                String?           @default("NOT_STARTED")
  aiAnalysisJson                  Json?
  overallScore                    Int?
  technicalScore                  Int?
  effortScore                     Int?
  pacingScore                     Int?
  executionScore                  Int?
  overallQualityExplanation       String?
  technicalExecutionExplanation   String?
  effortManagementExplanation     String?
  pacingStrategyExplanation       String?
  executionConsistencyExplanation String?
  completenessScore               Int?
  duplicateOf                     String?
  isDuplicate                     Boolean           @default(false)
  notes                           String?
  notesUpdatedAt                  DateTime?
  plannedWorkoutId                String?
  calories                        Int?
  commute                         Boolean?          @default(false)
  deviceName                      String?
  elapsedTimeSec                  Int?
  gearId                          String?
  isPrivate                       Boolean?          @default(false)
  shareToken                      String?           @unique
  carbsUsed                       Int?
  hrLoad                          Float?
  strainScore                     Float?
  wBalDepletion                   Int?
  wPrime                          Int?
  workAboveFtp                    Int?
  feedback                        String?
  feedbackText                    String?
  fitFile                         FitFile?
  planAdherence                   PlanAdherence?
  reports                         ReportWorkout[]
  canonicalWorkout                Workout?          @relation("WorkoutDuplicates", fields: [duplicateOf], references: [id])
  duplicates                      Workout[]         @relation("WorkoutDuplicates")
  plannedWorkout                  PlannedWorkout?   @relation(fields: [plannedWorkoutId], references: [id])
  user                            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercises                       WorkoutExercise[]
  streams                         WorkoutStream?

  @@unique([userId, source, externalId])
  @@index([userId, date])
  @@index([userId, isDuplicate])
  @@index([date])
}

model Exercise {
  id               String            @id @default(uuid())
  externalId       String?           @unique
  title            String
  type             String?
  primaryMuscle    String?
  secondaryMuscles String[]
  instructions     String?
  imageUrl         String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  workoutExercises WorkoutExercise[]
}

model WorkoutExercise {
  id         String       @id @default(uuid())
  workoutId  String
  exerciseId String
  notes      String?
  order      Int          @default(0)
  supersetId String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  exercise   Exercise     @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  workout    Workout      @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  sets       WorkoutSet[]

  @@index([workoutId])
  @@index([exerciseId])
}

model WorkoutSet {
  id                String          @id @default(uuid())
  workoutExerciseId String
  reps              Int?
  weight            Float?
  weightUnit        String?
  rpe               Float?
  durationSec       Int?
  distanceMeters    Float?
  type              String          @default("NORMAL")
  order             Int             @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  workoutExercise   WorkoutExercise @relation(fields: [workoutExerciseId], references: [id], onDelete: Cascade)

  @@index([workoutExerciseId])
}

model WorkoutStream {
  id               String   @id @default(uuid())
  workoutId        String   @unique
  time             Json?
  distance         Json?
  velocity         Json?
  heartrate        Json?
  cadence          Json?
  watts            Json?
  altitude         Json?
  latlng           Json?
  grade            Json?
  moving           Json?
  avgPacePerKm     Float?
  paceVariability  Float?
  lapSplits        Json?
  paceZones        Json?
  pacingStrategy   Json?
  surges           Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  hrZoneTimes      Json?
  powerZoneTimes   Json?
  hrv              Json?
  leftRightBalance Json?
  respiration      Json?
  temp             Json?
  torque           Json?
  workout          Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@index([workoutId])
}

model FitFile {
  id        String   @id @default(uuid())
  userId    String
  filename  String
  fileData  Bytes
  hash      String
  workoutId String?  @unique
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workout   Workout? @relation(fields: [workoutId], references: [id])

  @@index([userId])
  @@index([hash])
}

model PlannedWorkout {
  id                String                   @id @default(uuid())
  userId            String
  externalId        String
  date              DateTime                 @db.Date
  title             String
  description       String?
  type              String?
  category          String?
  durationSec       Int?
  distanceMeters    Float?
  tss               Float?
  workIntensity     Float?
  completed         Boolean?                 @default(false)
  rawJson           Json?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  lastSyncedAt      DateTime?
  modifiedLocally   Boolean                  @default(false)
  syncError         String?
  syncStatus        String?                  @default("SYNCED")
  shareToken        String?                  @unique
  completionStatus  String                   @default("PENDING")
  structuredWorkout Json?
  trainingWeekId    String?
  targetArea        String?
  managedBy         String                   @default("USER")
  fuelingStrategy   String?
  recommendations   ActivityRecommendation[]
  planAdherences    PlanAdherence[]
  trainingWeek      TrainingWeek?            @relation(fields: [trainingWeekId], references: [id])
  user              User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  completedWorkouts Workout[]

  @@unique([userId, externalId])
  @@index([userId, date])
  @@index([userId, syncStatus])
}

model CalendarNote {
  id           String    @id @default(uuid())
  userId       String
  startDate    DateTime
  endDate      DateTime?
  isWeeklyNote Boolean   @default(false)
  title        String
  description  String?
  category     String
  type         String?
  externalId   String
  source       String    @default("intervals")
  rawJson      Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, source, externalId])
  @@index([userId, startDate])
  @@index([userId, isWeeklyNote])
}

model DailyMetric {
  id            String   @id @default(uuid())
  userId        String
  date          DateTime @db.Date
  source        String
  hrv           Float?
  restingHr     Int?
  sleepScore    Int?
  hoursSlept    Float?
  recoveryScore Int?
  strainScore   Float?
  spO2          Float?
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

model Wellness {
  id               String    @id @default(uuid())
  userId           String
  date             DateTime  @db.Date
  hrv              Float?
  hrvSdnn          Float?
  restingHr        Int?
  avgSleepingHr    Int?
  sleepSecs        Int?
  sleepHours       Float?
  sleepScore       Int?
  sleepQuality     Int?
  readiness        Int?
  recoveryScore    Int?
  soreness         Int?
  fatigue          Int?
  stress           Int?
  mood             Int?
  motivation       Int?
  weight           Float?
  spO2             Float?
  ctl              Float?
  atl              Float?
  comments         String?
  rawJson          Json?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  abdomen          Float?
  bloodGlucose     Float?
  bodyFat          Float?
  diastolic        Int?
  hydration        String?
  hydrationVolume  Float?
  injury           String?
  lactate          Float?
  menstrualPhase   String?
  respiration      Float?
  skinTemp         Float?
  systolic         Int?
  vo2max           Float?
  aiAnalysis       String?
  aiAnalysisJson   Json?
  aiAnalysisStatus String?   @default("NOT_STARTED")
  aiAnalyzedAt     DateTime?
  feedback         String?
  feedbackText     String?
  history          Json?
  lastSource       String?
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

model Nutrition {
  id                            String            @id @default(uuid())
  userId                        String
  date                          DateTime          @db.Date
  calories                      Int?
  protein                       Float?
  carbs                         Float?
  fat                           Float?
  fiber                         Float?
  sugar                         Float?
  breakfast                     Json?
  lunch                         Json?
  dinner                        Json?
  snacks                        Json?
  caloriesGoal                  Int?
  proteinGoal                   Float?
  carbsGoal                     Float?
  fatGoal                       Float?
  waterMl                       Int?
  rawJson                       Json?
  createdAt                     DateTime          @default(now())
  updatedAt                     DateTime          @updatedAt
  aiAnalysis                    String?
  aiAnalysisJson                Json?
  aiAnalysisStatus              String?           @default("NOT_STARTED")
  aiAnalyzedAt                  DateTime?
  overallScore                  Int?
  macroBalanceScore             Int?
  qualityScore                  Int?
  adherenceScore                Int?
  hydrationScore                Int?
  nutritionalBalanceExplanation String?
  calorieAdherenceExplanation   String?
  macroDistributionExplanation  String?
  hydrationStatusExplanation    String?
  timingOptimizationExplanation String?
  notes                         String?
  notesUpdatedAt                DateTime?
  feedback                      String?
  feedbackText                  String?
  fuelingPlan                   Json?
  isManualLock                  Boolean           @default(false)
  sourcePrecedence              String?
  user                          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  reports                       ReportNutrition[]

  @@unique([userId, date])
  @@index([userId, date])
}

model UserNutritionSettings {
  id                 String   @id @default(uuid())
  userId             String   @unique
  bmr                Int?
  activityLevel      String?
  baseProteinPerKg   Float    @default(1.6)
  baseFatPerKg       Float    @default(1.0)
  currentCarbMax     Int      @default(60)
  ultimateCarbGoal   Int      @default(90)
  sweatRate          Float?
  sodiumTarget       Int      @default(750)
  preWorkoutWindow   Int      @default(120)
  postWorkoutWindow  Int      @default(60)
  carbsPerHourLow    Int      @default(30)
  carbsPerHourMedium Int      @default(60)
  carbsPerHourHigh   Int      @default(90)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model YazioProductCache {
  id        String   @id @default(uuid())
  productId String   @unique
  name      String
  brand     String?
  baseUnit  String?
  nutrients Json?
  fetchedAt DateTime @default(now())
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([expiresAt])
}

model ReportTemplate {
  id           String   @id @default(uuid())
  userId       String?
  name         String
  description  String?
  icon         String?
  isSystem     Boolean  @default(false)
  inputConfig  Json
  outputConfig Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  reports      Report[]
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isSystem])
}

model Report {
  id                             String            @id @default(uuid())
  userId                         String
  type                           String
  status                         String
  createdAt                      DateTime          @default(now())
  updatedAt                      DateTime          @updatedAt
  dateRangeStart                 DateTime
  dateRangeEnd                   DateTime
  modelVersion                   String?
  markdown                       String?
  latex                          String?
  pdfUrl                         String?
  suggestions                    Json?
  analysisJson                   Json?
  overallScore                   Int?
  trainingLoadScore              Int?
  recoveryScore                  Int?
  progressScore                  Int?
  consistencyScore               Int?
  trainingLoadExplanation        String?
  recoveryBalanceExplanation     String?
  progressTrendExplanation       String?
  adaptationReadinessExplanation String?
  injuryRiskExplanation          String?
  feedback                       String?
  feedbackText                   String?
  templateId                     String?
  template                       ReportTemplate?   @relation(fields: [templateId], references: [id])
  user                           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  nutrition                      ReportNutrition[]
  workouts                       ReportWorkout[]
}

model ReportWorkout {
  id        String   @id @default(uuid())
  reportId  String
  workoutId String
  createdAt DateTime @default(now())
  report    Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  workout   Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@unique([reportId, workoutId])
  @@index([reportId])
  @@index([workoutId])
}

model ReportNutrition {
  id          String    @id @default(uuid())
  reportId    String
  nutritionId String
  createdAt   DateTime  @default(now())
  nutrition   Nutrition @relation(fields: [nutritionId], references: [id], onDelete: Cascade)
  report      Report    @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@unique([reportId, nutritionId])
  @@index([reportId])
  @@index([nutritionId])
}

model ActivityRecommendation {
  id                 String          @id @default(uuid())
  userId             String
  date               DateTime        @db.Date
  recommendation     String
  confidence         Float
  reasoning          String
  analysisJson       Json?
  plannedWorkoutId   String?
  status             String          @default("PENDING")
  modelVersion       String?
  userAccepted       Boolean?
  userModified       Boolean?
  appliedToIntervals Boolean?        @default(false)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  plannedWorkout     PlannedWorkout? @relation(fields: [plannedWorkoutId], references: [id])
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
}

model TrainingPlan {
  id                     String          @id @default(uuid())
  userId                 String
  goalId                 String?
  startDate              DateTime?
  targetDate             DateTime?
  strategy               String          @default("LINEAR")
  status                 String          @default("ACTIVE")
  currentBlockId         String?
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  description            String?
  fromTemplateId         String?
  isTemplate             Boolean         @default(false)
  name                   String?
  activityTypes          Json?
  customInstructions     String?
  recoveryRhythm         Int             @default(4)
  hasBeenSavedAsTemplate Boolean         @default(false)
  blocks                 TrainingBlock[]
  template               TrainingPlan?   @relation("PlanTemplate", fields: [fromTemplateId], references: [id])
  derivedPlans           TrainingPlan[]  @relation("PlanTemplate")
  goal                   Goal?           @relation(fields: [goalId], references: [id], onDelete: Cascade)
  user                   User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([isTemplate])
}

model TrainingBlock {
  id                String         @id @default(uuid())
  trainingPlanId    String
  order             Int
  name              String
  type              String
  primaryFocus      String
  startDate         DateTime
  durationWeeks     Int
  recoveryWeekIndex Int?
  progressionLogic  String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  plan              TrainingPlan   @relation(fields: [trainingPlanId], references: [id], onDelete: Cascade)
  weeks             TrainingWeek[]

  @@index([trainingPlanId, order])
}

model TrainingWeek {
  id                  String           @id @default(uuid())
  blockId             String
  weekNumber          Int
  startDate           DateTime
  endDate             DateTime
  volumeTargetMinutes Int
  tssTarget           Int
  isRecovery          Boolean          @default(false)
  focus               String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  explanation         String?
  focusKey            String?
  focusLabel          String?
  workouts            PlannedWorkout[]
  block               TrainingBlock    @relation(fields: [blockId], references: [id], onDelete: Cascade)

  @@index([blockId, weekNumber])
}

model TrainingAvailability {
  id             String   @id @default(uuid())
  userId         String
  dayOfWeek      Int
  morning        Boolean  @default(false)
  afternoon      Boolean  @default(false)
  evening        Boolean  @default(false)
  preferredTypes Json?
  indoorOnly     Boolean  @default(false)
  outdoorOnly    Boolean  @default(false)
  gymAccess      Boolean  @default(false)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  bikeAccess     Boolean  @default(false)
  slots          Json?    // Detailed slot-specific availability
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayOfWeek])
  @@index([userId])
}

model WeeklyTrainingPlan {
  id                 String   @id @default(uuid())
  userId             String
  weekStartDate      DateTime @db.Date
  weekEndDate        DateTime @db.Date
  daysPlanned        Int      @default(7)
  status             String   @default("DRAFT")
  generatedBy        String   @default("AI")
  modelVersion       String?
  planJson           Json
  totalTSS           Float?
  totalDuration      Int?
  workoutCount       Int?
  userAccepted       Boolean?
  userModified       Boolean?
  appliedToIntervals Boolean? @default(false)
  notes              String?
  adjustmentReason   String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, weekStartDate])
  @@index([userId, status])
}

model ScoreTrendExplanation {
  id           String   @id @default(uuid())
  userId       String
  type         String
  period       Int
  metric       String
  score        Float?
  analysisData Json
  generatedAt  DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  llmUsageId   String?
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, period, metric])
  @@index([userId, type, period])
  @@index([expiresAt])
}

model Recommendation {
  id                  String    @id @default(uuid())
  userId              String
  sourceType          String
  metric              String
  period              Int
  title               String
  description         String
  priority            String
  generatedAt         DateTime  @default(now())
  completedAt         DateTime?
  isPinned            Boolean   @default(false)
  status              String    @default("ACTIVE")
  llmUsageId          String?
  history             Json?
  implementationGuide Json?
  category            String?
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, sourceType, metric])
  @@index([generatedAt])
  @@index([status])
  @@index([isPinned])
}

model DailyCheckin {
  id            String   @id @default(uuid())
  userId        String
  date          DateTime @db.Date
  questions     Json
  status        String   @default("PENDING")
  modelVersion  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  llmUsageId    String?
  feedback      String?
  feedbackText  String?
  userNotes     String?
  openingRemark String?
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

model ChatRoom {
  id        String            @id @default(uuid())
  name      String?
  avatar    String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  deletedAt DateTime?
  messages  ChatMessage[]
  users     ChatParticipant[]
  bugReports BugReport[]
}

model ChatParticipant {
  id       String    @id @default(uuid())
  userId   String
  roomId   String
  lastSeen DateTime?
  room     ChatRoom  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roomId])
}

model ChatMessage {
  id        String   @id @default(uuid())
  content   String
  roomId    String
  senderId  String
  files     Json?
  replyToId String?
  seen      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  metadata  Json?
  room      ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId, createdAt])
}

model SyncQueue {
  id          String    @id @default(uuid())
  userId      String
  entityType  String
  entityId    String
  operation   String
  payload     Json
  status      String    @default("PENDING")
  attempts    Int       @default(0)
  lastAttempt DateTime?
  error       String?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([status, createdAt])
}

model LlmUsage {
  id               String   @id @default(uuid())
  userId           String?
  provider         String
  model            String
  modelType        String?
  operation        String
  entityType       String?
  entityId         String?
  promptTokens     Int?
  completionTokens Int?
  cachedTokens     Int?     @default(0)
  reasoningTokens  Int?     @default(0)
  totalTokens      Int?
  estimatedCost    Float?
  durationMs       Int?
  ttft             Int?
  retryCount       Int      @default(0)
  success          Boolean
  errorType        String?
  errorMessage     String?
  promptPreview    String?
  responsePreview  String?
  createdAt        DateTime @default(now())
  promptFull       String?
  responseFull     String?
  feedback         String?
  feedbackText     String?
  user             User?    @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([operation, createdAt])
  @@index([provider, model, createdAt])
  @@index([success, createdAt])
  @@index([createdAt])
}

model PlanAdherence {
  id               String         @id @default(uuid())
  workoutId        String         @unique
  plannedWorkoutId String
  overallScore     Int?
  intensityScore   Int?
  durationScore    Int?
  executionScore   Int?
  summary          String?
  deviations       Json?
  recommendations  Json?
  analysisStatus   String         @default("PENDING")
  analyzedAt       DateTime?
  modelVersion     String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  plannedWorkout   PlannedWorkout @relation(fields: [plannedWorkoutId], references: [id], onDelete: Cascade)
  workout          Workout        @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@index([workoutId])
  @@index([plannedWorkoutId])
}

model SupportMessage {
  id                   String   @id @default(uuid())
  userId               String?
  email                String?
  name                 String?
  subject              String
  message              String
  autotaskTicketId     String?
  autotaskTicketNumber String?
  status               String   @default("OPEN")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([email])
}

model WebhookLog {
  id          String    @id @default(uuid())
  provider    String
  eventType   String?
  payload     Json?
  headers     Json?
  query       Json?
  status      String    @default("PENDING")
  error       String?
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([provider, eventType])
  @@index([createdAt])
  @@index([status])
}

model LlmAnalysisLevelSettings {
  id               String   @id @default(uuid())
  level            String   @unique // 'flash', 'pro', 'experimental'
  model            String   @default("flash") // flash/pro family
  modelId          String   @default("gemini-flash-latest") // exact ID
  thinkingBudget   Int      @default(2000)
  thinkingLevel    String   @default("low")
  maxSteps         Int      @default(3)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  overrides        LlmOperationOverride[]
}

model LlmOperationOverride {
  id                       String   @id @default(uuid())
  analysisLevelSettingsId  String
  operation                String
  model                    String?
  modelId                  String?
  thinkingBudget           Int?
  thinkingLevel            String?
  maxSteps                 Int?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  analysisLevelSettings     LlmAnalysisLevelSettings @relation(fields: [analysisLevelSettingsId], references: [id], onDelete: Cascade)

  @@unique([analysisLevelSettingsId, operation])
}

enum SubscriptionTier {
  FREE
  SUPPORTER
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
  NONE
  CONTRIBUTOR
}

model BugReport {
  id          String    @id @default(uuid())
  userId      String
  chatRoomId  String?
  title       String
  description String
  context     Json?
  logs        String?
  status      BugStatus @default(OPEN)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatRoom    ChatRoom? @relation(fields: [chatRoomId], references: [id])

  @@index([userId])
  @@index([chatRoomId])
  @@index([status])
}

enum BugStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}
