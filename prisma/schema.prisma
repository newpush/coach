// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// --------------------------------------
// User & Auth (NuxtAuth / NextAuth Standard)
// --------------------------------------

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Settings for Coaching
  ftp           Int?      // Functional Threshold Power (Watts)
  maxHr         Int?      // Max Heart Rate
  weight        Float?    // Weight in kg (for W/kg calcs)
  dob           DateTime? // Date of birth for age-based metrics

  // Relations
  accounts      Account[]
  sessions      Session[]
  integrations    Integration[] // External App Connections (Whoop, Intervals)
  workouts        Workout[]
  plannedWorkouts PlannedWorkout[]
  dailyMetrics    DailyMetric[]
  wellness        Wellness[]
  nutrition       Nutrition[]
  reports         Report[]
  activityRecommendations ActivityRecommendation[]
  trainingAvailability TrainingAvailability[]
  weeklyTrainingPlans WeeklyTrainingPlan[]
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// --------------------------------------
// App Integrations (The "Senses")
// --------------------------------------

// Stores tokens for external fitness apps (Intervals.icu, Whoop, Strava)
// Distinct from 'Account' which is for Login/SSO
model Integration {
  id             String    @id @default(uuid())
  userId         String
  provider       String    // "intervals", "whoop", "strava", "garmin"
  
  // Auth Data
  accessToken    String
  refreshToken   String?
  expiresAt      DateTime?
  externalUserId String?   // The user's ID in the external system
  scope          String?   // What permissions we have

  // Sync Status
  lastSyncAt     DateTime?
  syncStatus     String?   // "SUCCESS", "FAILED", "SYNCING"
  errorMessage   String?

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
}

// --------------------------------------
// Normalized Fitness Data
// --------------------------------------

// A unified structure for workouts from any provider
model Workout {
  id              String   @id @default(uuid())
  userId          String
  externalId      String   // ID from the source (e.g., Strava Activity ID)
  source          String   // "intervals", "strava"
  
  // Core Data
  date            DateTime
  title           String
  description     String?  @db.Text
  type            String?  // "Ride", "Run", "WeightTraining"

  // Performance Metrics
  durationSec     Int
  distanceMeters  Float?
  elevationGain   Int?
  
  // Power & Heart Rate
  averageWatts    Int?
  maxWatts        Int?
  normalizedPower Int?
  weightedAvgWatts Int?
  averageHr       Int?
  maxHr           Int?
  averageCadence  Int?
  maxCadence      Int?
  averageSpeed    Float?
  
  // Training Load & Intensity
  tss             Float?   // Training Stress Score
  trainingLoad    Float?   // icu_training_load
  intensity       Float?   // Intensity Factor (0-1+ scale)
  kilojoules      Int?
  trimp           Int?
  
  // Performance Metrics
  ftp             Int?     // FTP at time of activity
  variabilityIndex Float?  // Power variability (NP/AP)
  powerHrRatio    Float?   // Power/HR efficiency
  efficiencyFactor Float?  // Power/HR at aerobic intensities
  decoupling      Float?   // Aerobic efficiency metric
  polarizationIndex Float? // Training distribution metric
  
  // Training Status (from Intervals.icu)
  ctl             Float?   // Chronic Training Load (Fitness)
  atl             Float?   // Acute Training Load (Fatigue)
  
  // Subjective Metrics
  rpe             Int?     // Rate of Perceived Exertion
  sessionRpe      Int?     // Session RPE
  feel            Int?     // How the workout felt (1-10)
  
  // Environmental & Equipment
  avgTemp         Float?   // Average temperature
  trainer         Boolean? // Indoor trainer workout
  
  // L/R Balance
  lrBalance       Float?   // Left/Right power balance
  
  // AI Analysis
  aiAnalysis      String?  @db.Text // AI-generated workout analysis (markdown fallback)
  aiAnalysisJson  Json?    // Structured analysis data for rich UI display
  aiAnalysisStatus String? @default("NOT_STARTED") // NOT_STARTED, PENDING, PROCESSING, COMPLETED, FAILED
  aiAnalyzedAt    DateTime? // When the analysis was generated
  
  // Raw Data storage (for re-analysis and accessing original data)
  rawJson         Json?    // Store the original full payload

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reports         ReportWorkout[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, date])
  @@unique([userId, source, externalId]) // Prevent duplicates
}

// Planned workouts from Intervals.icu
model PlannedWorkout {
  id              String   @id @default(uuid())
  userId          String
  externalId      String   // ID from Intervals.icu
  
  // Core Data
  date            DateTime @db.Date // When the workout is planned for
  title           String
  description     String?  @db.Text
  type            String?  // "Ride", "Run", etc.
  category        String?  // "WORKOUT", "EVENT", "NOTE"
  
  // Planned Metrics
  durationSec     Int?     // Planned duration
  distanceMeters  Float?   // Planned distance
  tss             Float?   // Planned TSS
  workIntensity   Float?   // Planned intensity
  
  // Status
  completed       Boolean? @default(false)
  workoutId       String?  // Link to actual workout if completed
  
  // Raw Data
  rawJson         Json?    // Store the original full payload
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  recommendations ActivityRecommendation[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId, date])
  @@unique([userId, externalId]) // Prevent duplicates
}

// Normalized Daily Health Data (Recovery, Sleep)
model DailyMetric {
  id             String   @id @default(uuid())
  userId         String
  date           DateTime @db.Date // YYYY-MM-DD
  source         String   // "whoop", "garmin", "oura"

  // Heart & Recovery
  hrv            Float?   // rMSSD (ms)
  restingHr      Int?
  
  // Sleep
  sleepScore     Int?     // 0-100
  hoursSlept     Float?
  
  // Proprietary Scores (Normalized)
  recoveryScore  Int?     // 0-100 (Whoop style)
  strainScore    Float?   // 0-21 (Whoop style) or similar
  
  spO2           Float?

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

// Wellness data from Intervals.icu (synced from various sources like Whoop, Garmin, etc.)
model Wellness {
  id                String   @id @default(uuid())
  userId            String
  date              DateTime @db.Date // YYYY-MM-DD
  
  // Heart Rate Variability
  hrv               Float?   // Heart Rate Variability (ms)
  hrvSdnn           Float?   // HRV SDNN - autonomic nervous system balance
  
  // Heart Rate
  restingHr         Int?     // Resting heart rate
  avgSleepingHr     Int?     // Average sleeping heart rate
  
  // Sleep Metrics
  sleepSecs         Int?     // Total sleep in seconds
  sleepHours        Float?   // Computed: sleepSecs / 3600
  sleepScore        Int?     // Sleep quality score (0-100)
  sleepQuality      Int?     // Sleep quality rating (1-10)
  
  // Recovery & Readiness
  readiness         Int?     // Readiness to train (1-10)
  recoveryScore     Int?     // Recovery score (0-100)
  
  // Subjective Wellness Metrics
  soreness          Int?     // Muscle soreness (1-10)
  fatigue           Int?     // Fatigue level (1-10)
  stress            Int?     // Stress level (1-10)
  mood              Int?     // Mood rating (1-10)
  motivation        Int?     // Motivation level (1-10)
  
  // Physical Metrics
  weight            Float?   // Weight in kg
  spO2              Float?   // Blood oxygen saturation (%)
  
  // Training Load (from Intervals.icu)
  ctl               Float?   // Chronic Training Load (Fitness)
  atl               Float?   // Acute Training Load (Fatigue)
  
  // Notes
  comments          String?  @db.Text
  
  // Raw data for accessing original response
  rawJson           Json?
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
}

// Nutrition data from Yazio
model Nutrition {
  id                String   @id @default(uuid())
  userId            String
  date              DateTime @db.Date
  
  // Daily Summary
  calories          Int?     // Total calories consumed
  protein           Float?   // Protein in grams
  carbs             Float?   // Carbohydrates in grams
  fat               Float?   // Fat in grams
  fiber             Float?   // Fiber in grams
  sugar             Float?   // Sugar in grams
  
  // Meal Breakdown
  breakfast         Json?    // Breakfast items and macros
  lunch             Json?    // Lunch items and macros
  dinner            Json?    // Dinner items and macros
  snacks            Json?    // Snacks items and macros
  
  // Nutrition Goals vs Actual
  caloriesGoal      Int?
  proteinGoal       Float?
  carbsGoal         Float?
  fatGoal           Float?
  
  // Water intake
  waterMl           Int?     // Water in milliliters
  
  // AI Analysis
  aiAnalysis        String?  @db.Text // AI-generated nutrition analysis (markdown fallback)
  aiAnalysisJson    Json?    // Structured analysis data for rich UI display
  aiAnalysisStatus  String?  @default("NOT_STARTED") // NOT_STARTED, PENDING, PROCESSING, COMPLETED, FAILED
  aiAnalyzedAt      DateTime? // When the analysis was generated
  
  // Raw data for re-analysis
  rawJson           Json?
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reports           ReportNutrition[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([userId, date])
  @@index([userId, date])
}

// Yazio Product Cache - stores product details to avoid rate limiting
model YazioProductCache {
  id              String   @id @default(uuid())
  productId       String   @unique // Yazio product ID
  
  // Product details
  name            String
  brand           String?
  baseUnit        String?  // e.g., "g", "ml"
  
  // Nutritional info per 100g/ml
  nutrients       Json?    // Full nutrient data
  
  // Cache metadata
  fetchedAt       DateTime @default(now())
  expiresAt       DateTime // Long TTL (e.g., 1 year - nutrition rarely changes)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([productId])
  @@index([expiresAt])
}

// --------------------------------------
// AI Agent Outputs
// --------------------------------------

model Report {
  id             String   @id @default(uuid())
  userId         String
  type           String   // "WEEKLY_ANALYSIS", "RACE_PREP", "DAILY_SUGGESTION"
  status         String   // "PENDING", "PROCESSING", "COMPLETED", "FAILED"
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Metadata
  dateRangeStart DateTime
  dateRangeEnd   DateTime
  modelVersion   String?  // e.g., "gemini-2.5-pro"
  
  // Content
  markdown       String?  @db.Text  // Markdown fallback for compatibility/exports
  analysisJson   Json?              // Structured analysis data for rich UI display
  latex          String?  @db.Text  // If we generated a formal document
  pdfUrl         String?  // URL to stored PDF in S3/Blob storage
  
  // Structured Suggestions (for the "Coach" agent)
  suggestions    Json?    // e.g., { "action": "rest", "reason": "HRV low" }

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workouts       ReportWorkout[]
  nutrition      ReportNutrition[]
}

// Many-to-many relationship between Reports and Workouts
model ReportWorkout {
  id         String   @id @default(uuid())
  reportId   String
  workoutId  String
  
  report     Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  workout    Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now())
  
  @@unique([reportId, workoutId])
  @@index([reportId])
  @@index([workoutId])
}

// Many-to-many relationship between Reports and Nutrition
model ReportNutrition {
  id          String   @id @default(uuid())
  reportId    String
  nutritionId String
  
  report      Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  nutrition   Nutrition @relation(fields: [nutritionId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@unique([reportId, nutritionId])
  @@index([reportId])
  @@index([nutritionId])
}

// --------------------------------------
// Activity Recommendations
// --------------------------------------

model ActivityRecommendation {
  id          String   @id @default(uuid())
  userId      String
  date        DateTime @db.Date
  
  // Analysis results
  recommendation String   // proceed, modify, reduce_intensity, rest
  confidence     Float    // 0.0 to 1.0
  reasoning      String   @db.Text
  
  // Structured JSON with full analysis
  analysisJson   Json?
  
  // Linked planned workout (if exists)
  plannedWorkoutId String?
  plannedWorkout   PlannedWorkout? @relation(fields: [plannedWorkoutId], references: [id])
  
  // Status tracking
  status      String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  modelVersion String?
  
  // User actions
  userAccepted Boolean? // Did user accept the recommendation?
  userModified Boolean? // Did user modify before accepting?
  appliedToIntervals Boolean? @default(false) // Synced to Intervals.icu?
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId, date])
}

// --------------------------------------
// Training Plan Management
// --------------------------------------

// User's training availability preferences
model TrainingAvailability {
  id          String   @id @default(uuid())
  userId      String
  
  // Day of week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)
  dayOfWeek   Int      // 0-6
  
  // Time slots available (morning, afternoon, evening)
  morning     Boolean  @default(false) // 5am-12pm
  afternoon   Boolean  @default(false) // 12pm-6pm
  evening     Boolean  @default(false) // 6pm-11pm
  
  // Preferred workout types for this slot
  preferredTypes Json? // Array of workout types: ["Ride", "Run", "Gym", "Swim"]
  
  // Location/equipment constraints
  indoorOnly  Boolean  @default(false)
  outdoorOnly Boolean  @default(false)
  gymAccess   Boolean  @default(false)
  
  // Notes
  notes       String?  @db.Text
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, dayOfWeek])
  @@index([userId])
}

// AI-Generated weekly training plans
model WeeklyTrainingPlan {
  id                String   @id @default(uuid())
  userId            String
  
  // Plan period
  weekStartDate     DateTime @db.Date  // Monday of the week
  weekEndDate       DateTime @db.Date  // Sunday of the week
  daysPlanned       Int      @default(7) // Number of days planned (default 7)
  
  // Plan metadata
  status            String   @default("DRAFT") // DRAFT, ACTIVE, COMPLETED, ARCHIVED
  generatedBy       String   @default("AI")    // AI, USER, COACH
  modelVersion      String?  // e.g., "gemini-2.0-flash-exp"
  
  // Plan details (JSON structure with daily workouts)
  planJson          Json     // Full plan structure with daily recommendations
  
  // Summary stats
  totalTSS          Float?   // Total planned TSS for the week
  totalDuration     Int?     // Total planned duration in seconds
  workoutCount      Int?     // Number of planned workouts
  
  // User feedback
  userAccepted      Boolean? // Did user accept the plan?
  userModified      Boolean? // Did user modify the plan?
  appliedToIntervals Boolean? @default(false) // Synced to Intervals.icu?
  
  // Notes and adjustments
  notes             String?  @db.Text
  adjustmentReason  String?  @db.Text // Why plan was modified
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([userId, weekStartDate])
  @@index([userId, status])
}
