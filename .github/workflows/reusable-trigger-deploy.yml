name: Trigger.dev Deploy

on:
  workflow_call:
    inputs:
      environment:
        description: GitHub environment for secrets (e.g., preview, production)
        type: string
        required: true
      trigger-env:
        description: Trigger.dev environment to deploy to (e.g., staging, production)
        type: string
        required: false
      trigger-version:
        description: Trigger.dev CLI version to use
        type: string
        default: "4.3.3"
        required: false
      node-version:
        description: Node.js version to use
        type: string
        default: "22"
        required: false
      preview-branch:
        description: Enable preview branch deployment (auto-detects from git branch)
        type: boolean
        default: false
        required: false
      branch-name:
        description: Specific branch name for preview deployment (overrides auto-detection)
        type: string
        required: false
    secrets:
      TRIGGER_ACCESS_TOKEN:
        description: Trigger.dev access token
        required: true
      TRIGGER_API_URL:
        description: Trigger.dev API URL (required for self-hosted)
        required: false
      TRIGGER_PROJECT_REF:
        description: Trigger.dev project reference
        required: true
      DATABASE_URL:
        description: Database URL for Prisma (can be dummy value for build)
        required: false
      DISCORD_WEBHOOK:
        description: Discord webhook URL for notifications
        required: false

jobs:
  deploy:
    name: Deploy Trigger.dev Tasks
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://dummy:dummy@localhost:5432/dummy' }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.13.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "pnpm"

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile

      - name: Verify Trigger.dev configuration
        run: |
          echo "Verifying trigger.config.ts exists..."
          if [ ! -f "trigger.config.ts" ]; then
            echo "::error::trigger.config.ts not found in project root"
            exit 1
          fi

          echo "Checking trigger.dev package versions..."
          pnpm list @trigger.dev/sdk @trigger.dev/build || true

      - name: Check Trigger.dev endpoint connectivity
        env:
          TRIGGER_API_URL: ${{ secrets.TRIGGER_API_URL }}
        run: |
          if [ -n "${TRIGGER_API_URL}" ]; then
            # Sanitize quotes/whitespace/CR from secrets using sed to avoid GH Actions expression confusion
            API_URL=$(echo "${TRIGGER_API_URL}" | sed -e 's/^[[:space:]"'"'"']*//' -e 's/[[:space:]"'"'"']*$//')

            # Extract host for DNS diagnostics
            HOST=$(echo "${API_URL}" | sed -E 's#^https?://##; s#/.*$##')

            echo "üåê Checking connectivity to ${API_URL} (host: ${HOST})..."
            echo "--- /etc/resolv.conf ---"
            cat /etc/resolv.conf || true
            echo "--- getent hosts ${HOST} ---"
            getent hosts "${HOST}" || echo "(no getent entry)"

            HTTP_CODE=$(curl -sS -o /dev/null -w "%{http_code}" --connect-timeout 10 -L "${API_URL}" || echo "000")
            if [ "${HTTP_CODE}" = "000" ]; then
              echo "::error::Cannot connect to ${API_URL}. DNS/egress/firewall issue or incorrect API URL."
              exit 1
            fi
            echo "‚úÖ Endpoint reachable (HTTP ${HTTP_CODE})"
          else
            echo "‚ÑπÔ∏è  TRIGGER_API_URL not set; will use Trigger.dev Cloud default."
          fi

      # Skipping interactive login; rely on TRIGGER_ACCESS_TOKEN for non-interactive auth

      - name: Deploy to Trigger.dev
        env:
          TRIGGER_ACCESS_TOKEN: ${{ secrets.TRIGGER_ACCESS_TOKEN }}
          TRIGGER_PROJECT_REF: ${{ secrets.TRIGGER_PROJECT_REF }}
          TRIGGER_API_URL: ${{ secrets.TRIGGER_API_URL }}
        run: |
          echo "üîé Preflight:"
          if [ -n "${TRIGGER_ACCESS_TOKEN}" ]; then echo "  TRIGGER_ACCESS_TOKEN: present"; else echo "  TRIGGER_ACCESS_TOKEN: MISSING"; fi
          if [ -n "${TRIGGER_API_URL}" ]; then echo "  TRIGGER_API_URL: ${TRIGGER_API_URL}"; else echo "  TRIGGER_API_URL: not set (defaults to Trigger.dev Cloud)"; fi
          if [ -n "${TRIGGER_PROJECT_REF}" ]; then echo "  TRIGGER_PROJECT_REF: ${TRIGGER_PROJECT_REF}"; else echo "  TRIGGER_PROJECT_REF: not set (will rely on config)"; fi

          npx trigger.dev@${{ inputs.trigger-version }} deploy

      - name: Verify deployment
        env:
          TRIGGER_ACCESS_TOKEN: ${{ secrets.TRIGGER_ACCESS_TOKEN }}
          TRIGGER_PROJECT_REF: ${{ secrets.TRIGGER_PROJECT_REF }}
          TRIGGER_API_URL: ${{ secrets.TRIGGER_API_URL }}
        run: |
          # Determine which Trigger.dev environment was used
          TRIGGER_ENV="${{ inputs.trigger-env }}"
          if [ -z "${TRIGGER_ENV}" ]; then
            TRIGGER_ENV="${{ inputs.environment }}"
          fi

          echo "‚úÖ Skipping CLI verification (no deployments list cmd in v4)."
          echo "Deployment context:"
          echo "  GitHub Environment: ${{ inputs.environment }}"
          echo "  Trigger.dev Environment: ${TRIGGER_ENV}"
          echo "  Preview branch: ${{ inputs.preview-branch }} ${{ inputs.branch-name }}"
          echo "  Trigger version: ${{ inputs.trigger-version }}"
          echo "  API URL set: $([[ -n "${TRIGGER_API_URL}" ]] && echo yes || echo no)"
          echo "  Project ref set: $([[ -n "${TRIGGER_PROJECT_REF}" ]] && echo yes || echo no)"

          echo "üéâ Trigger.dev deployment completed successfully!"

      - name: Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always() && env.DISCORD_WEBHOOK != ''
        with:
          webhook: ${{ env.DISCORD_WEBHOOK }}
          title: "Deploy Status - ${{ github.repository }}"
          description: |
            **Deploy:** ${{ job.status }}
            **Environment:** ${{ inputs.environment }}
            **Trigger Env:** ${{ inputs.trigger-env || inputs.environment }}
          color: ${{ job.status == 'success' && '0x28a745' || '0xdc3545' }}

      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up temporary files..."
          # Add any cleanup steps here if needed
